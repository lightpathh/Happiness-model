<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>総幸福量予測モデル</title>
<meta name="theme-color" content="#111111">
<link rel="manifest" href="manifest.json">
<style>
body {
  background-color: #111;
  color: #eee;
  font-family: "Segoe UI", sans-serif;
  margin: 2em;
}
h1 {
  text-align: center;
  margin-bottom: 1.5em;
  color: #8fdcff;
}
label {
  display: block;
  margin-top: 1em;
  font-weight: bold;
}
input, select, textarea, button {
  width: 100%;
  padding: 0.6em;
  margin-top: 0.3em;
  border: none;
  border-radius: 6px;
  background-color: #222;
  color: #fff;
  box-sizing: border-box;
}
button {
  cursor: pointer;
  transition: background 0.2s;
}
button:hover {
  background-color: #444;
}
#calculate {
  background-color: #2b82ff;
  font-weight: bold;
}
#calculate:hover {
  background-color: #146ce6;
}
#delete {
  background-color: #ff3c3c;
}
.history-item {
  background-color: #1b1b1b;
  padding: 0.6em;
  margin-top: 0.5em;
  border-radius: 6px;
}
.history-item span {
  display: inline-block;
  margin-right: 1em;
}
#result {
  background-color: #1b1b1b;
  padding: 1em;
  border-radius: 6px;
  text-align: center;
  font-size: 1.2em;
  margin-top: 1em;
}
</style>
</head>
<body>
<h1>総幸福量予測モデル</h1>

<form id="happinessForm">
  <label>M（動機の質 0.1〜2.0）<br><small>自律的な動機ほど高い</small></label>
  <input type="number" id="M" min="0.1" max="2.0" step="0.1" required>

  <label>T（待機時間）<br><small>得たいと思ってから得るまでの時間</small></label>
  <input type="number" id="T" min="0" step="1" required>
  <select id="Tunit">
    <option value="1">日</option>
    <option value="7">週</option>
    <option value="30">月</option>
    <option value="365">年</option>
  </select>

  <label>E（経験効用 1〜10）<br><small>体験中の平均的な満足度</small></label>
  <input type="number" id="E" min="1" max="10" step="0.1" required>

  <label>P（ピーク強度 1〜10）<br><small>体験中の最も幸福な瞬間の強さ</small></label>
  <input type="number" id="P" min="1" max="10" step="0.1" required>

  <label>R（日常統合度 0.1〜1.0）<br><small>その体験が日常にどれほど組み込まれるか</small></label>
  <input type="number" id="R" min="0.1" max="1.0" step="0.1" required>

  <label>メモ（内容や文脈など）</label>
  <textarea id="memo" rows="2" placeholder="例：カメラ購入、旅行計画など"></textarea>

  <button type="button" id="calculate">計算する</button>
</form>

<div id="result">結果がここに表示されます</div>

<h2>履歴</h2>
<div id="history"></div>

<button id="exportCsv">CSV出力</button>

<script>
// ----------------- メイン計算 -----------------
function calcH(M, T, E, P, R) {
  return M * (Math.log(1 + T) + E) + R * P;
}

function getTdays(value, unitMultiplier) {
  return value * unitMultiplier; // 日換算
}

document.getElementById("calculate").addEventListener("click", () => {
  const M = parseFloat(document.getElementById("M").value);
  const T = parseFloat(document.getElementById("T").value);
  const unit = parseFloat(document.getElementById("Tunit").value);
  const E = parseFloat(document.getElementById("E").value);
  const P = parseFloat(document.getElementById("P").value);
  const R = parseFloat(document.getElementById("R").value);
  const memo = document.getElementById("memo").value.trim();
  if (isNaN(M) || isNaN(T) || isNaN(E) || isNaN(P) || isNaN(R)) {
    alert("すべての項目を入力してください。");
    return;
  }

  const Tdays = getTdays(T, unit);
  const H = calcH(M, Tdays, E, P, R).toFixed(2);

  document.getElementById("result").textContent = `総幸福量 H = ${H}`;

  saveHistory({ date: new Date().toLocaleString(), memo, H });
});

// ----------------- 履歴管理 -----------------
function loadHistory() {
  const data = JSON.parse(localStorage.getItem("happiness_history") || "[]");
  const container = document.getElementById("history");
  container.innerHTML = "";
  data.forEach((item, i) => {
    const div = document.createElement("div");
    div.className = "history-item";
    div.innerHTML = `<span>${item.date}</span><span>${item.memo}</span>
    <button id="delete" onclick="deleteHistory(${i})">削除</button>
    <button onclick="loadEntry(${i})">読み込み</button>`;
    container.appendChild(div);
  });
}

function saveHistory(entry) {
  const data = JSON.parse(localStorage.getItem("happiness_history") || "[]");
  data.push(entry);
  localStorage.setItem("happiness_history", JSON.stringify(data));
  loadHistory();
}

function deleteHistory(index) {
  const data = JSON.parse(localStorage.getItem("happiness_history") || "[]");
  data.splice(index, 1);
  localStorage.setItem("happiness_history", JSON.stringify(data));
  loadHistory();
}

function loadEntry(index) {
  const data = JSON.parse(localStorage.getItem("happiness_history") || "[]");
  const item = data[index];
  if (!item) return;
  document.getElementById("memo").value = item.memo;
  document.getElementById("result").textContent = `選択中：${item.memo}（H=${item.H}）`;
}

loadHistory();

// ----------------- CSV出力 -----------------
document.getElementById("exportCsv").addEventListener("click", () => {
  const data = JSON.parse(localStorage.getItem("happiness_history") || "[]");
  if (data.length === 0) return alert("履歴がありません。");
  const csv = ["日付,メモ,総幸福量(H)"];
  data.forEach(d => csv.push(`${d.date},${d.memo},${d.H}`));
  const blob = new Blob([csv.join("\n")], { type: "text/csv" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "happiness_history.csv";
  a.click();
});

// ----------------- PWA Service Worker -----------------
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("sw.js");
}
</script>
</body>
</html>