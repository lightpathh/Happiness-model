<!doctype html>
<html lang="ja" style="background:#100f0c;color:#f2ede5;">
<head>
<script>
  (function() {
    try {
      const t = localStorage.getItem('hflow_theme');
      if (t === 'light') document.documentElement.classList.add('light');
    } catch(e){}
    document.documentElement.style.visibility = 'hidden';
  })();
</script>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="color-scheme" content="dark light">
<title>H.Flow - å¹¸ç¦è¦³å¯Ÿãƒ„ãƒ¼ãƒ«</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Lora:wght@400;600&family=Nunito:wght@400;600;700;800&display=block" rel="stylesheet">
<style>
/* ===== FOUCé˜²æ­¢: ãƒ†ãƒ¼ãƒèƒŒæ™¯ã®å³æ™‚åæ˜  ===== */
html       { background-color: #100f0c; color: #f2ede5; }
html.light { background-color: #f7f5f1; color: #292520; }

/* ===== H.Flow ãƒ†ãƒ¼ãƒå¤‰æ•° (dark) ===== */
:root {
  --bg:       #100f0c;
  --bg2:      #1a1814;
  --card:     #25221d;
  --border:   rgba(255,255,255,0.12);
  --text:     #f2ede5;
  --muted:    #a89d8b;
  --accent:   #c8a96e;
  --accent2:  #e0c58e;
  --ant:      #6caee0;
  --exp:      #7cc57a;
  --rec:      #e4c85a;
  --ant-dim:  rgba(106,171,220,0.18);
  --exp-dim:  rgba(123,200,122,0.18);
  --rec-dim:  rgba(232,200,85,0.18);
  --bad:      #e07070;
  --shadow:   0 4px 24px rgba(0,0,0,0.55);
  --radius:   14px;
  --font-head:'Lora', Georgia, serif;
  --font-body:'Nunito','Yu Gothic UI',Meiryo,sans-serif;
}

/* ===== ãƒ†ãƒ¼ãƒå¤‰æ•° (light) ===== */
:root.light {
  --bg:       #f7f5f1;
  --bg2:      #eeebe6;
  --card:     #ffffff;
  --border:   rgba(0,0,0,0.15);
  --text:     #292520;
  --muted:    #5e5549;
  --accent:   #a07025;
  --accent2:  #c4963a;
  --ant:      #2f82c2;
  --exp:      #319c31;
  --rec:      #b88c15;
  --ant-dim:  rgba(42,128,190,0.20);
  --exp-dim:  rgba(46,158,46,0.20);
  --rec-dim:  rgba(184,144,16,0.20);
  --bad:      #c03030;
  --shadow:   0 4px 20px rgba(0,0,0,0.12);
}

.subtitle,
.formula-bar,
.var-desc,
.h-note,
.tendency-box { opacity: 0.9; }

:root.light input[type=range] { background: rgba(0,0,0,0.12); }

*, *::before, *::after { box-sizing: border-box; }
html, body { margin: 0; padding: 0; background: var(--bg); color: var(--text); font-family: var(--font-body); min-height: 100vh; }
body { padding: 16px 16px 56px; opacity: 0; transition: opacity 0.35s ease; }
body.ready { opacity: 1; }

body::before {
  content: '';
  position: fixed; inset: 0;
  background:
    radial-gradient(ellipse 80% 50% at 20% 10%, rgba(200,169,110,0.06) 0%, transparent 60%),
    radial-gradient(ellipse 60% 40% at 80% 80%, rgba(106,171,220,0.05) 0%, transparent 60%);
  pointer-events: none; z-index: 0;
}
body > * { position: relative; z-index: 1; }

:root { transition: background-color 0.35s ease, color 0.35s ease; }

.wrap { max-width: 600px; margin: 0 auto; display: flex; flex-direction: column; gap: 14px; }

/* ãƒ˜ãƒƒãƒ€ãƒ¼ */
header { padding: 8px 0 2px; }
.title-row { display: flex; align-items: baseline; gap: 10px; flex-wrap: wrap; }
h1 {
  font-family: var(--font-head);
  font-size: 1.75rem; font-weight: 600; margin: 0; letter-spacing: -0.02em;
  background: linear-gradient(120deg, var(--accent2) 0%, var(--text) 70%);
  -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
}
.subtitle { font-size: 0.82rem; color: var(--muted); font-style: italic; font-family: var(--font-head); }
.formula-bar { margin-top: 5px; font-size: 0.80rem; color: var(--muted); letter-spacing: 0.01em; }

/* ã‚«ãƒ¼ãƒ‰ */
.card {
  background: var(--card); border-radius: var(--radius);
  padding: 18px; display: flex; flex-direction: column; gap: 14px;
  box-shadow: var(--shadow); border: 1px solid var(--border);
  animation: fadeUp 0.4s ease both; will-change: opacity, transform;
}
.card:nth-of-type(1){animation-delay:0.00s}
.card:nth-of-type(2){animation-delay:0.07s}
.card:nth-of-type(3){animation-delay:0.14s}

/* ãƒ†ãƒ¼ãƒãƒˆã‚°ãƒ« */
.theme-toggle {
  position: fixed; top: 14px; right: 16px;
  background: var(--card); border: 1px solid var(--border);
  border-radius: 10px; padding: 6px 11px; font-size: 1rem;
  cursor: pointer; color: var(--text); box-shadow: var(--shadow); z-index: 100;
  transition: background 0.3s;
}

/* å¤‰æ•°ãƒ©ãƒ™ãƒ« */
.var-label { display: flex; justify-content: space-between; align-items: center; margin-bottom: 3px; }
.var-name { font-size: 0.88rem; color: var(--muted); font-weight: 700; letter-spacing: 0.05em; }
.var-desc { font-size: 0.80rem; color: var(--muted); font-style: italic; font-family: var(--font-head); margin-left: 8px; }
.var-val { font-size: 1.0rem; font-weight: 800; color: var(--accent2); min-width: 40px; text-align: right; }

/* å…¥åŠ› */
input[type=number], select {
  padding: 9px 12px; border-radius: 9px; border: 1px solid var(--border);
  background: rgba(255,255,255,0.04); color: var(--text);
  font-family: var(--font-body); font-size: 1rem; width: 100%; transition: border-color 0.2s;
}
:root.light input[type=number], :root.light select { background: rgba(0,0,0,0.03); border: 1px solid rgba(0,0,0,0.1); }
input[type=number]:focus, select:focus { outline: none; border-color: var(--accent); }
.flex-row { display: flex; gap: 8px; align-items: center; }

/* ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ */
.slider-wrap { display: flex; flex-direction: column; gap: 5px; transition: opacity 0.3s; }
.slider-wrap.locked { opacity: 0.38; pointer-events: none; }
input[type=range] {
  -webkit-appearance: none; appearance: none; width: 100%;
  height: 5px; border-radius: 3px; background: var(--border); outline: none; cursor: pointer;
}
input[type=range]::-webkit-slider-thumb {
  -webkit-appearance: none; width: 20px; height: 20px; border-radius: 50%;
  background: var(--accent); box-shadow: 0 2px 8px rgba(0,0,0,0.3);
  cursor: pointer; transition: transform 0.15s;
}
input[type=range]::-webkit-slider-thumb:active { transform: scale(1.25); }
input[type=range].exp-r::-webkit-slider-thumb { background: var(--exp); }
input[type=range].rec-r::-webkit-slider-thumb { background: var(--rec); }
.scale-hint { display: flex; justify-content: space-between; font-size: 0.70rem; color: var(--muted); }

/* ç·¨é›†ãƒˆã‚°ãƒ« */
.edit-row { display: flex; justify-content: flex-end; align-items: center; gap: 8px; }
.edit-lbl { font-size: 0.80rem; color: var(--muted); }
.sw { position: relative; width: 42px; height: 24px; cursor: pointer; }
.sw input { opacity: 0; width: 0; height: 0; }
.sw-track { position: absolute; inset: 0; background: var(--border); border-radius: 12px; transition: background 0.3s; }
.sw input:checked + .sw-track { background: var(--accent); }
.sw-thumb { position: absolute; top: 3px; left: 3px; width: 18px; height: 18px; border-radius: 50%; background: #fff; transition: transform 0.3s; box-shadow: 0 1px 4px rgba(0,0,0,0.3); }
.sw input:checked ~ .sw-thumb { transform: translateX(18px); }

/* Hè¡¨ç¤º */
.h-display {
  display: flex; align-items: baseline; gap: 10px;
  padding: 10px 14px; border-radius: 10px;
  background: rgba(255,255,255,0.02); border: 1px solid var(--border);
}
.h-label { font-size: 0.80rem; color: var(--muted); font-weight: 700; letter-spacing: 0.06em; }
.h-value { font-size: 1.3rem; font-weight: 800; color: var(--accent2); font-family: var(--font-head); }
.h-note { font-size: 0.75rem; color: var(--muted); margin-left: auto; font-style: italic; font-family: var(--font-head); }

/* æ£’ã‚°ãƒ©ãƒ• */
.chart-title { font-family: var(--font-head); font-size: 0.95rem; font-weight: 600; }
.chart-area { display: flex; gap: 10px; align-items: flex-end; height: 190px; padding: 0 4px; }
.bar-col { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: flex-end; height: 100%; gap: 7px; }
.bar-outer {
  width: 100%; height: 100%; border-radius: 10px 10px 4px 4px;
  position: relative; overflow: hidden;
}
.bar-outer.ant { background: var(--ant-dim); }
.bar-outer.exp { background: var(--exp-dim); }
.bar-outer.rec { background: var(--rec-dim); }
.bar-fill {
  position: absolute; bottom: 0; left: 0; right: 0;
  border-radius: 10px 10px 4px 4px;
  transition: height 0.65s cubic-bezier(0.34,1.4,0.64,1);
}
.bar-fill.ant { background: linear-gradient(180deg, rgba(140,200,240,0.9), var(--ant)); }
.bar-fill.exp { background: linear-gradient(180deg, rgba(160,220,160,0.9), var(--exp)); }
.bar-fill.rec { background: linear-gradient(180deg, rgba(240,220,120,0.9), var(--rec)); }
.bar-num {
  position: absolute; top: 7px; left: 0; right: 0;
  text-align: center; font-size: 0.78rem; font-weight: 800; color: var(--text); opacity: 0.9;
}
.bar-tag { font-size: 0.78rem; font-weight: 700; color: var(--muted); white-space: nowrap; }
.bar-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 3px; vertical-align: middle; }

/* æ§‹æˆæ¯” */
.ratio-row { display: flex; gap: 6px; flex-wrap: wrap; }
.ratio-pill { flex: 1; text-align: center; padding: 6px 8px; border-radius: 8px; font-size: 0.80rem; font-weight: 700; }
.ratio-pill.ant { background: var(--ant-dim); color: var(--ant); }
.ratio-pill.exp { background: var(--exp-dim); color: var(--exp); }
.ratio-pill.rec { background: var(--rec-dim); color: var(--rec); }

/* å‚¾å‘ãƒœãƒƒã‚¯ã‚¹ */
.tendency-box {
  padding: 11px 14px; border-radius: 10px;
  background: rgba(255,255,255,0.02); border: 1px solid var(--border);
  font-size: 0.84rem; color: var(--muted); line-height: 1.65;
  font-style: italic; font-family: var(--font-head); min-height: 50px;
  transition: color 0.4s;
}
:root.light .tendency-box { background: rgba(0,0,0,0.02); }

/* ãƒœã‚¿ãƒ³ */
button {
  border: 0; border-radius: 10px; padding: 10px 14px;
  font-family: var(--font-body); font-weight: 700; cursor: pointer;
  transition: all 0.22s; font-size: 0.9rem;
}
.btn-primary {
  background: linear-gradient(135deg, var(--accent) 0%, var(--accent2) 100%);
  color: #13120f; letter-spacing: 0.02em;
}
.btn-primary:hover { filter: brightness(1.1); transform: translateY(-1px); }
.btn-ghost { background: transparent; border: 1px solid var(--border); color: var(--text); }
.btn-ghost:hover { border-color: var(--accent); color: var(--accent); }
.btn-small { padding: 7px 11px; border-radius: 8px; font-size: 0.82rem; }
.btn-danger { background: var(--bad); color: #fff; padding: 7px 10px; border-radius: 8px; font-size: 0.80rem; }

/* å±¥æ­´ */
.history-list { display: flex; flex-direction: column; gap: 8px; max-height: 320px; overflow: auto; }
.hist-item {
  display: flex; flex-direction: column; padding: 10px 12px;
  border-radius: 10px; background: rgba(255,255,255,0.015);
  border: 1px solid var(--border); transition: border-color 0.2s;
}
.hist-item:hover { border-color: rgba(200,169,110,0.3); }
.hist-top { display: flex; justify-content: space-between; align-items: center; }
.hist-meta { font-size: 0.78rem; color: var(--muted); }
.hist-memo { font-weight: 800; margin-top: 4px; font-size: 0.88rem; }
.hist-bars { display: flex; gap: 3px; margin-top: 6px; height: 4px; border-radius: 2px; overflow: hidden; }
.mini-seg { height: 100%; transition: flex 0.4s; }
.hist-h { font-size: 0.75rem; color: var(--muted); margin-top: 4px; }

/* ãƒˆãƒ¼ã‚¹ãƒˆ */
.toast {
  position: fixed; top: 20px; left: 50%; transform: translate(-50%, -30px);
  background: var(--card); border: 1px solid var(--accent); color: var(--text);
  padding: 9px 18px; border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.4);
  opacity: 0; transition: opacity 0.4s ease, transform 0.4s cubic-bezier(0.25,1,0.5,1);
  z-index: 99999; pointer-events: none; font-size: 0.86rem; font-weight: 600;
}
.toast.show { opacity: 1; transform: translate(-50%, 0); }
.toast.hide  { opacity: 0; transform: translate(-50%, -30px); }

.input-error { border: 2px solid var(--bad) !important; animation: shake 0.3s ease-in-out; }
@keyframes shake { 0%,100%{transform:translateX(0)} 25%{transform:translateX(-4px)} 75%{transform:translateX(4px)} }

.sort-active { background: var(--accent) !important; color: #13120f !important; border: none !important; }

footer { font-size: 0.76rem; color: var(--muted); text-align: center; margin-top: 8px; font-style: italic; font-family: var(--font-head); }

.history-list::-webkit-scrollbar { width: 4px; }
.history-list::-webkit-scrollbar-track { background: transparent; }
.history-list::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

@keyframes fadeUp { from{opacity:0;transform:translateY(10px)} to{opacity:1;transform:translateY(0)} }

hr.div { border: none; border-top: 1px solid var(--border); margin: 2px 0; }
</style>
</head>
<body>
<button id="themeToggle" class="theme-toggle">ğŸŒ™</button>

<div class="wrap">
  <header>
    <div class="title-row">
      <h1>H.Flow</h1>
      <span class="subtitle">å¹¸ç¦è¦³å¯Ÿãƒ„ãƒ¼ãƒ«</span>
    </div>
    <div class="formula-bar">H = M Ã— [ln(1+T) + E] + PÃ—V</div>
  </header>

  <!-- å…¥åŠ›ã‚«ãƒ¼ãƒ‰ -->
  <section class="card">
    <div class="edit-row">
      <span class="edit-lbl" id="editLbl">ç·¨é›†ãƒ¢ãƒ¼ãƒ‰</span>
      <label class="sw">
        <input type="checkbox" id="editToggle">
        <span class="sw-track"></span>
        <span class="sw-thumb"></span>
      </label>
    </div>

    <!-- T -->
    <div>
      <div class="var-label">
        <div><span class="var-name">T</span><span class="var-desc">å¾…ã£ã¦ã„ã‚‹æœŸé–“</span></div>
        <span class="var-val" id="Tval">0æ—¥</span>
      </div>
      <div class="flex-row">
        <input id="T" type="number" min="0" step="1" placeholder="ä¾‹: 0" style="flex:2;">
        <select id="Tunit" style="flex:1;">
          <option value="day">æ—¥</option>
          <option value="week">é€±</option>
          <option value="month">æœˆ</option>
          <option value="year">å¹´</option>
        </select>
      </div>
    </div>

    <hr class="div">

    <!-- M -->
    <div>
      <div class="var-label">
        <div><span class="var-name">M</span><span class="var-desc">å‹•æ©Ÿã®è³ª</span></div>
        <span class="var-val" id="Mval">1.0</span>
      </div>
      <div class="slider-wrap" id="Mwrap">
        <input type="range" id="M" min="0.1" max="2.0" step="0.1" value="1.0">
        <div class="scale-hint"><span>0.1 å¤–ç™ºçš„</span><span>1.0 ä¸­é–“</span><span>2.0 å†…ç™ºçš„</span></div>
      </div>
    </div>

    <!-- E -->
    <div>
      <div class="var-label">
        <div><span class="var-name">E</span><span class="var-desc">å¹³å‡çš„ãªå¹¸ç¦æ„Ÿ</span></div>
        <span class="var-val" id="Eval">5</span>
      </div>
      <div class="slider-wrap" id="Ewrap">
        <input type="range" id="E" min="1" max="10" step="1" value="5" class="exp-r">
        <div class="scale-hint"><span>1 ä½ã„</span><span style="color:var(--exp)">5</span><span>10 é«˜ã„</span></div>
      </div>
    </div>

    <!-- P -->
    <div>
      <div class="var-label">
        <div><span class="var-name">P</span><span class="var-desc">ãƒ”ãƒ¼ã‚¯ã®å¹¸ç¦æ„Ÿ</span></div>
        <span class="var-val" id="Pval">5</span>
      </div>
      <div class="slider-wrap" id="Pwrap">
        <input type="range" id="P" min="1" max="10" step="1" value="5" class="rec-r">
        <div class="scale-hint"><span>1 ä½ã„</span><span style="color:var(--rec)">5</span><span>10 é«˜ã„</span></div>
      </div>
    </div>

    <!-- V -->
    <div>
      <div class="var-label">
        <div><span class="var-name">V</span><span class="var-desc">ä¾¡å€¤è¦³åˆè‡´åº¦</span></div>
        <span class="var-val" id="Vval">0.5</span>
      </div>
      <div class="slider-wrap" id="Vwrap">
        <input type="range" id="V" min="0.1" max="1.0" step="0.1" value="0.5" class="rec-r">
        <div class="scale-hint"><span>0.1 ä½ã„</span><span style="color:var(--rec)">0.5</span><span>1.0 é«˜ã„</span></div>
      </div>
    </div>

    <div class="flex-row" style="flex-wrap:wrap; gap:8px; margin-top:2px;">
      <button id="calcBtn" class="btn-primary">è¦³å¯Ÿã™ã‚‹</button>
      <button id="saveBtn" class="btn-ghost btn-small">å±¥æ­´ä¿å­˜</button>
      <button id="exportBtn" class="btn-ghost btn-small">CSVå‡ºåŠ›</button>
    </div>
  </section>

  <!-- çµæœã‚«ãƒ¼ãƒ‰ -->
  <section class="card">
    <div class="h-display">
      <span class="h-label">H</span>
      <span class="h-value" id="Hout">â€”</span>
      <span class="h-note">ç·å¹¸ç¦é‡</span>
    </div>

    <div class="chart-title">å¹¸ç¦ã®ä¸‰æˆåˆ†</div>
    <div class="chart-area">
      <div class="bar-col">
        <div class="bar-outer ant">
          <div class="bar-fill ant" id="barAnt" style="height:0%">
            <div class="bar-num" id="numAnt">â€”</div>
          </div>
        </div>
        <div class="bar-tag"><span class="bar-dot" style="background:var(--ant)"></span>äºˆæœŸ</div>
      </div>
      <div class="bar-col">
        <div class="bar-outer exp">
          <div class="bar-fill exp" id="barExp" style="height:0%">
            <div class="bar-num" id="numExp">â€”</div>
          </div>
        </div>
        <div class="bar-tag"><span class="bar-dot" style="background:var(--exp)"></span>çµŒé¨“</div>
      </div>
      <div class="bar-col">
        <div class="bar-outer rec">
          <div class="bar-fill rec" id="barRec" style="height:0%">
            <div class="bar-num" id="numRec">â€”</div>
          </div>
        </div>
        <div class="bar-tag"><span class="bar-dot" style="background:var(--rec)"></span>æƒ³èµ·</div>
      </div>
    </div>

    <div class="ratio-row">
      <div class="ratio-pill ant" id="ratioAnt">äºˆæœŸ â€”%</div>
      <div class="ratio-pill exp" id="ratioExp">çµŒé¨“ â€”%</div>
      <div class="ratio-pill rec" id="ratioRec">æƒ³èµ· â€”%</div>
    </div>

    <div class="tendency-box" id="tendencyBox">ã€Œè¦³å¯Ÿã™ã‚‹ã€ã‚’æŠ¼ã™ã¨ã€å¹¸ç¦ã®å‚¾å‘ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</div>
  </section>

  <!-- å±¥æ­´ã‚«ãƒ¼ãƒ‰ -->
  <section class="card">
    <div class="flex-row" style="flex-wrap:wrap; gap:6px;">
      <button id="sortHBtn" class="btn-ghost btn-small">H é«˜ã„é †</button>
      <button id="sortTimeBtn" class="btn-ghost btn-small">æ™‚ç³»åˆ—</button>
      <div style="flex:1;"></div>
      <button id="clearAllBtn" class="btn-ghost btn-small">å…¨ä»¶å‰Šé™¤</button>
    </div>
    <div class="history-list" id="historyList"></div>
  </section>

  <footer>Happiness Flow Model</footer>
</div>

<script>
const SK  = 'hflow_history_v1';
const TK  = 'hflow_theme';
const SMK = 'hflow_sort_mode';
const EPS = 1e-9;
const rnd = (v, dp=4) => { const m=10**dp; return Math.round(v*m)/m; };
const qs  = s => document.querySelector(s);
const toN = v => { const n=Number(v); return isFinite(n)?n:NaN; };

function loadHistory() {
  try { return JSON.parse(localStorage.getItem(SK) || '[]'); }
  catch { return []; }
}

function convertT(val, unit) {
  if (!isFinite(val) || val < 0) return NaN;
  return unit==='week'?val*7:unit==='month'?val*30:unit==='year'?val*365:val;
}

function compute({M, T, E, P, V}) {
  const ant = M * Math.log(1 + T);
  const exp_ = M * E;
  const rec  = P * V;
  return { H: rnd(ant+exp_+rec,4), ant: rnd(ant,4), exp: rnd(exp_,4), rec: rnd(rec,4) };
}

function showToast(msg) {
  document.querySelectorAll('.toast').forEach(el => el.remove());
  const t = document.createElement('div');
  t.className='toast'; t.textContent=msg;
  document.body.appendChild(t);
  setTimeout(()=>t.classList.add('show'), 50);
  setTimeout(()=>{
    t.classList.remove('show'); t.classList.add('hide');
    setTimeout(()=>t.remove(), 500);
  }, 2800);
}

function shakeEl(el) {
  el.classList.remove('input-error'); void el.offsetWidth;
  el.classList.add('input-error'); setTimeout(()=>el.classList.remove('input-error'), 3000);
}

// DOM refs
const Tinput   = qs('#T'),   TunitSel = qs('#Tunit');
const Minput   = qs('#M'),   Einput   = qs('#E');
const Pinput   = qs('#P'),   Vinput   = qs('#V');
const Tval     = qs('#Tval'),  Mval = qs('#Mval'), Eval = qs('#Eval'), Pval = qs('#Pval'), Vval = qs('#Vval');
const calcBtn  = qs('#calcBtn'), saveBtn = qs('#saveBtn'), exportBtn = qs('#exportBtn');
const clearAllBtn = qs('#clearAllBtn'), historyList = qs('#historyList');
const editToggle  = qs('#editToggle'),  editLbl     = qs('#editLbl'), themeToggle = qs('#themeToggle');
const sortHBtn    = qs('#sortHBtn'),    sortTimeBtn = qs('#sortTimeBtn');
const Hout   = qs('#Hout');
const barAnt = qs('#barAnt'), barExp = qs('#barExp'), barRec = qs('#barRec');
const numAnt = qs('#numAnt'), numExp = qs('#numExp'), numRec = qs('#numRec');
const ratioAnt = qs('#ratioAnt'), ratioExp = qs('#ratioExp'), ratioRec = qs('#ratioRec');
const tendencyBox = qs('#tendencyBox');

let lastResult = null;

// ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼è¡¨ç¤ºæ›´æ–°
Minput.oninput = () => Mval.textContent = Number(Minput.value).toFixed(1);
Einput.oninput = () => Eval.textContent = Einput.value;
Pinput.oninput = () => Pval.textContent = Pinput.value;
Vinput.oninput = () => Vval.textContent = Number(Vinput.value).toFixed(1);
Tinput.oninput = () => {
  const v = Tinput.value === '' ? 0 : toN(Tinput.value);
  const d = convertT(v, TunitSel.value);
  Tval.textContent = (isFinite(d) && d >= 0) ? `${rnd(d,1)}æ—¥` : 'â€”';
};
TunitSel.onchange = () => Tinput.dispatchEvent(new Event('input'));

// ç·¨é›†ãƒ¢ãƒ¼ãƒ‰
const sliderWraps = ['Mwrap','Ewrap','Pwrap','Vwrap'].map(id=>qs('#'+id));
function applyEdit(on) {
  sliderWraps.forEach(w => on ? w.classList.remove('locked') : w.classList.add('locked'));
  editLbl.textContent = on ? 'ç·¨é›†ãƒ¢ãƒ¼ãƒ‰' : 'ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ (OFF)';
}
editToggle.onchange = () => applyEdit(editToggle.checked);
applyEdit(false);

// å‚¾å‘ã‚³ãƒ¡ãƒ³ãƒˆ
function getTendency(ant, exp, rec, H) {
  if (H < EPS) return 'ã€Œè¦³å¯Ÿã™ã‚‹ã€ã‚’æŠ¼ã™ã¨ã€å¹¸ç¦ã®å‚¾å‘ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚';
  const total = ant + exp + rec;
  const sorted = [['ant',ant/total],['exp',exp/total],['rec',rec/total]].sort((a,b)=>b[1]-a[1]);
  const domMsg = {
    ant: 'ã‚ãªãŸã®å¹¸ç¦ã¯ã€ŒäºˆæœŸãƒ»æœŸå¾…ã€ã«è‰²ã¥ã„ã¦ã„ã¾ã™ã€‚å¾…ã¤æ™‚é–“ãã®ã‚‚ã®ã‚‚å¹¸ã›ã®ä¸€éƒ¨ã ã£ãŸã‚Šã—ã¾ã™ã€‚',
    exp: 'ã‚ãªãŸã®å¹¸ç¦ã¯ã€ŒçµŒé¨“ãƒ»ä½“é¨“ã€ãŒä¸­å¿ƒã§ã™ã€‚ç”Ÿãã¦ã„ã‚‹ã‚ã„ã ã«ã—ã‹å‘³ã‚ãˆãªã„ã€ã€Œä»Šã“ã“ã€ã®æ„Ÿè¦šãã®ã‚‚ã®ã§ã™ã€‚',
    rec: 'ã‚ãªãŸã®å¹¸ç¦ã¯ã€Œæƒ³èµ·ãƒ»è¨˜æ†¶ã€ã«å®¿ã£ã¦ã„ã¾ã™ã€‚ä½“é¨“ãŒä¾¡å€¤è¦³ã¨çµã³ã¤ãã€é•·ãå¿ƒã«æ®‹ã£ã¦ã„ã‚‹ã‚ˆã†ã§ã™ã€‚',
  }[sorted[0][0]];
  const spread = sorted[0][1] - sorted[2][1];
  const balanceMsg = spread < 0.2
    ? ' ä¸‰ã¤ã®æˆåˆ†ãŒãƒãƒ©ãƒ³ã‚¹ã‚ˆãåˆ†å¸ƒã—ãŸç©ã‚„ã‹ãªå¹¸ç¦åƒã§ã™ã€‚'
    : spread > 0.55
      ? ' çªå‡ºã—ãŸæˆåˆ†ãŒã‚ã‚Šã€ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªå¹¸ç¦ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æŒã£ã¦ã„ã¾ã™ã€‚'
      : '';
  return domMsg + balanceMsg;
}

// ã‚°ãƒ©ãƒ•æ›´æ–°
function updateChart({ H, ant, exp, rec }) {
  Hout.textContent = isFinite(H) ? H.toFixed(3) : 'â€”';
  const maxV = Math.max(ant, exp, rec, EPS);
  const pct = v => Math.round((v/maxV)*86);
  barAnt.style.height = pct(ant)+'%'; numAnt.textContent = ant.toFixed(2);
  barExp.style.height = pct(exp)+'%'; numExp.textContent = exp.toFixed(2);
  barRec.style.height = pct(rec)+'%'; numRec.textContent = rec.toFixed(2);
  const total = ant + exp + rec;
  if (total > EPS) {
    ratioAnt.textContent = `äºˆæœŸ ${Math.round(ant/total*100)}%`;
    ratioExp.textContent = `çµŒé¨“ ${Math.round(exp/total*100)}%`;
    ratioRec.textContent = `æƒ³èµ· ${Math.round(rec/total*100)}%`;
  }
  tendencyBox.textContent = getTendency(ant, exp, rec, H);
}

// è¨ˆç®—ãƒœã‚¿ãƒ³
calcBtn.onclick = () => {
  if (Tinput.value.trim() === '') {
    showToast('T ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
    shakeEl(Tinput);
    Tinput.scrollIntoView({ behavior: 'smooth', block: 'center' });
    return;
  }
  const Tdays = convertT(toN(Tinput.value), TunitSel.value);
  const M = toN(Minput.value), E = toN(Einput.value);
  const P = toN(Pinput.value), V = toN(Vinput.value);
  if (!isFinite(Tdays)||Tdays<0) { showToast('T ã«æœ‰åŠ¹ãªå€¤ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); shakeEl(Tinput); return; }
  if (!isFinite(M)||!isFinite(E)||!isFinite(P)||!isFinite(V)) { showToast('ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã®å€¤ãŒä¸æ­£ã§ã™'); return; }
  const res = compute({ M, T:Tdays, E, P, V });
  lastResult = { M, T:Tdays, Tunit:TunitSel.value, E, P, V, ...res };
  updateChart(res);
};

// ä¿å­˜
saveBtn.onclick = () => {
  if (!lastResult) { showToast('å…ˆã«ã€Œè¦³å¯Ÿã™ã‚‹ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„'); return; }
  const memo = prompt('ãƒ¡ãƒ¢ã‚’å…¥åŠ›ï¼ˆä¾‹: æ—…è¡Œã®å‰æ—¥ï¼‰');
  if (memo === null) return;
  const entry = { id:'h'+Date.now(), ts:new Date().toISOString(), memo:memo.trim(), ...lastResult };
  const arr = loadHistory();
  arr.unshift(entry); localStorage.setItem(SK, JSON.stringify(arr));
  renderHistory(); showToast('ğŸ’¾ ä¿å­˜ã—ã¾ã—ãŸ');
};

// CSVå‡ºåŠ›
exportBtn.onclick = () => {
  const arr = loadHistory();
  if (!arr.length) { showToast('å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“'); return; }
  if (!confirm('å±¥æ­´ã‚’CSVã¨ã—ã¦å‡ºåŠ›ã—ã¾ã™ã‹ï¼Ÿ')) return;
  const rows = [['ts','M','T(æ—¥æ›ç®—)','E','P','V','H','äºˆæœŸ','çµŒé¨“','æƒ³èµ·','memo']];
  arr.forEach(e => rows.push([e.ts,e.M,e.T,e.E,e.P,e.V,e.H,e.ant,e.exp,e.rec,e.memo]));
  const csv = new Blob([rows.map(r=>r.map(c=>`"${String(c??'').replace(/"/g,'""')}"`).join(',')).join('\n')],{type:'text/csv'});
  const url = URL.createObjectURL(csv);
  const a = document.createElement('a');
  a.href=url; a.download='hflow_history.csv';
  document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
};

// å…¨ä»¶å‰Šé™¤
clearAllBtn.onclick = () => {
  if (confirm('å±¥æ­´ã‚’å…¨ã¦å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) { localStorage.removeItem(SK); renderHistory(); }
};

// å±¥æ­´æç”»
function renderHistory() {
  const arr = loadHistory();
  if (!arr.length) {
    historyList.innerHTML='<div style="color:var(--muted);font-size:0.83rem;padding:2px 0;">ã¾ã è¦³å¯Ÿè¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</div>';
    return;
  }
  historyList.innerHTML = '';
  arr.forEach(item => {
    const total = (item.ant||0)+(item.exp||0)+(item.rec||0);
    const pa = total>EPS ? Math.round((item.ant||0)/total*100) : 0;
    const pe = total>EPS ? Math.round((item.exp||0)/total*100) : 0;
    const pr = 100-pa-pe;

    const el   = document.createElement('div'); el.className='hist-item';
    const top  = document.createElement('div'); top.className='hist-top';
    const meta = document.createElement('div'); meta.className='hist-meta';
    meta.textContent = new Date(item.ts).toLocaleString('ja-JP');

    const acts    = document.createElement('div'); acts.style.cssText='display:flex;gap:6px;';
    const loadBtn = document.createElement('button');
    loadBtn.className='btn-ghost btn-small'; loadBtn.textContent='èª­è¾¼';
    loadBtn.dataset.action='load'; loadBtn.dataset.id=item.id;
    const delBtn  = document.createElement('button');
    delBtn.className='btn-danger'; delBtn.textContent='å‰Šé™¤';
    delBtn.dataset.action='del'; delBtn.dataset.id=item.id;
    acts.append(loadBtn, delBtn);
    top.append(meta, acts);

    const memo = document.createElement('div'); memo.className='hist-memo';
    memo.textContent = item.memo||'';

    const bars = document.createElement('div'); bars.className='hist-bars';
    bars.innerHTML=`
      <div class="mini-seg" style="background:var(--ant);flex:${pa}"></div>
      <div class="mini-seg" style="background:var(--exp);flex:${pe}"></div>
      <div class="mini-seg" style="background:var(--rec);flex:${pr}"></div>
    `;

    const hl = document.createElement('div'); hl.className='hist-h';
    hl.textContent = `H=${(item.H||0).toFixed(3)}  äºˆ${pa}% çµŒ${pe}% æƒ³${pr}%`;

    el.append(top, memo, bars, hl);
    historyList.appendChild(el);
  });
}

// ã‚¤ãƒ™ãƒ³ãƒˆå§”è­² (å±¥æ­´: èª­è¾¼ãƒ»å‰Šé™¤)
historyList.addEventListener('click', ev => {
  const btn = ev.target.closest('button'); if (!btn) return;
  const { action, id } = btn.dataset;
  const arr = loadHistory();
  if (action === 'load') {
    const item = arr.find(x=>x.id===id); if (!item) return;
    const unit = item.Tunit || 'day';
    const tVal = unit==='week'?rnd(item.T/7,2):unit==='month'?rnd(item.T/30,2):unit==='year'?rnd(item.T/365,2):item.T;
    Tinput.value=tVal; TunitSel.value=unit;
    Minput.value=item.M; Mval.textContent=Number(item.M).toFixed(1);
    Einput.value=item.E; Eval.textContent=item.E;
    Pinput.value=item.P; Pval.textContent=item.P;
    Vinput.value=item.V; Vval.textContent=Number(item.V).toFixed(1);
    Tinput.dispatchEvent(new Event('input'));
    lastResult = {...item};
    updateChart({ H:item.H, ant:item.ant, exp:item.exp, rec:item.rec });
    window.scrollTo({ top:0, behavior:'smooth' });
  } else if (action === 'del') {
    if (!confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
    localStorage.setItem(SK, JSON.stringify(arr.filter(x=>x.id!==id)));
    renderHistory();
  }
});

// ã‚½ãƒ¼ãƒˆ
function setSortMode(mode) {
  const arr = loadHistory();
  if (mode==='H') arr.sort((a,b)=>(b.H||0)-(a.H||0));
  else            arr.sort((a,b)=>new Date(b.ts)-new Date(a.ts));
  localStorage.setItem(SK, JSON.stringify(arr));
  localStorage.setItem(SMK, mode);
  renderHistory();
  sortHBtn.classList.toggle('sort-active',    mode==='H');
  sortTimeBtn.classList.toggle('sort-active', mode!=='H');
}
sortHBtn.onclick    = () => setSortMode('H');
sortTimeBtn.onclick = () => setSortMode('time');
setSortMode(localStorage.getItem(SMK)==='H' ? 'H' : 'time');

// ãƒ†ãƒ¼ãƒ
function applyTheme(mode) {
  document.documentElement.classList.toggle('light', mode==='light');
  themeToggle.textContent = mode==='light' ? 'ğŸŒ™' : 'â˜€ï¸';
  localStorage.setItem(TK, mode);
}
themeToggle.onclick = () => {
  applyTheme(document.documentElement.classList.contains('light') ? 'dark' : 'light');
};
(function(){
  const s = localStorage.getItem(TK);
  applyTheme(s || (window.matchMedia('(prefers-color-scheme:light)').matches ? 'light' : 'dark'));
})();

// ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³
document.addEventListener('DOMContentLoaded', () => {
  requestAnimationFrame(() => {
    document.documentElement.style.visibility = 'visible';
    document.body.classList.add('ready');
  });
});
</script>
</body>
</html>